#!/usr/bin/env python
# run phyml with standard command-line interface

import sys, os, shutil
import optparse

from rasmus import util, treelib
from rasmus.bio import phylip, fasta
from rasmus.bio import phylorun as phy


o = optparse.OptionParser()
phy.add_common_options(o)
conf, files = phy.parse_common_options(o)


for fn in files:
    basename = phy.get_basename(fn, conf)

    outdir = basename + conf.outputext
    phy.make_output_dir(outdir)
    align = fasta.readFasta(basename + conf.alignext)
    labels = phylip.writePhylipAlign(file(outdir + "/infile", "w"), align,
                                     False)
    util.write_list(file(outdir + "/labels", "w"), labels)

    if len(align) <= 2:
        continue

    if conf.usertreeext:
        tree = treelib.read_tree(basename + conf.usertreeext)
        treelib.unroot(tree, newCopy=False)
        usertree = outdir + "/usertree"
        tree.write(usertree)
    else:
        usertree = "BIONJ"
    

    nrates = 4
    if conf.seqtype == "dna":
        args = "%s/infile 0 s 1 %d HKY e e %d e %s %s y" % \
               (outdir, conf.boot, nrates, usertree, "ny"[int(conf.opttree)])
    else:
        args = "%s/infile 1 s 1 %d JTT e %d e %s %s y" % \
               (outdir, conf.boot, nrates, usertree, "ny"[int(conf.opttree)])
    cmd = "phyml " + args + " > '%s/out'" % outdir
    print cmd
    out = open(outdir + "/cmd", "w")
    out.write(cmd)
    out.close()
    assert os.system(cmd) == 0

    #tree = phylip.readOutTree(outdir + "/infile_phyml_tree.txt", labels)
    tree = treelib.readTree(outdir + "/infile_phyml_tree.txt")

    tree.write(basename + conf.treeext)

