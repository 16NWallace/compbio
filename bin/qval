#!/usr/bin/env python
# compute FDR using rpy

import sys, optparse
from itertools import izip

import rpy

# options
o = optparse.OptionParser()
o.add_option("-d", "--delim", dest="delim",
             metavar="<DELIM>", default="\t")
o.add_option("-p", "--pval", dest="pvalcol",
             metavar="<PVALUE COLUMN>",
             type="int", default=1)
o.add_option("-q", "--qval", dest="qvalcol",
             metavar="<QVALUE COLUMN>",
             type="int", default=None)

conf, args = o.parse_args()

# get input files
if len(args) == 0:
    files = [sys.stdin]
else:
    files = [open(f) for f in files]

# read data
data = []
for infile in files:
    for line in infile:
        data.append(line.rstrip().split(conf.delim))

# compute qvalues
pvals = [float(row[conf.pvalcol-1]) for row in data]
qvals = rpy.r.p_adjust(pvals, "fdr")


if conf.qvalcol is not None:
    conf.qvalcol = conf.qvalcol - 1

# write data
for q, row in izip(qvals, data):
    row2 = row[:conf.qvalcol] + [str(q)]
    if conf.qvalcol is not None:
        row2 += row[conf.qvalcol:]
    print conf.delim.join(row2)




