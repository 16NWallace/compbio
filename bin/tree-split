#!/usr/bin/env python

import sys

from rasmus import util
from rasmus import treelib

from rasmus.bio import phylo
from rasmus.bio import genomeutil

options = [
 ["S:", "smap=", "smap", "<gene2speces map>",
    {"single": True}],
 ["s:", "stree=", "stree", "<species tree>",
    {"single": True}],
 ["T:", "treeext=", "treeext", "<tree filename extension>",
    {"single": True,
     "default": ".tree"}],
 ["Y:", "subtreeext=", "subtreeext", "<subtree filename extension>",
    {"single": True,
     "default": ".sub.tree"}],
]

conf = util.parseOptions(sys.argv, options, resthelp="<tree file> ...")

gene2species = genomeutil.readGene2species(conf["smap"])
stree = treelib.readTree(conf["stree"])


def splitTree(tree, stree, gene2species):
    """            
    - If root is a pre-speciation duplication:
	    - reconRoot tree
	    - If root is still a pre-speciation duplication
		    - remove root and split the tree into two separate trees
		    - recurse    
    """

    recon = phylo.reconcile(tree, stree, gene2species)
    events = phylo.labelEvents(tree, recon)

    if events[tree.root] == "dup" and \
       recon[tree.root] == stree.root:
        phylo.reconRoot(tree, stree, gene2species, newCopy=False)
        recon = phylo.reconcile(tree, stree, gene2species)
        events = phylo.labelEvents(tree, recon)
        
        if events[tree.root] == "dup" and \
           recon[tree.root] == stree.root:
            subtrees = []
            
            for child in tree.root.children:
                subtrees.append(treelib.subtree(tree, child))
                
                # use the max bootstrap for the root branches
                tree2 = subtrees[-1]
                if tree2.hasData("boot") and len(tree2.root.children) == 2:
                    boot = max(tree2.root.children[0].data["boot"],
                               tree2.root.children[1].data["boot"])
                    tree2.root.children[0].data["boot"] = boot
                    tree2.root.children[1].data["boot"] = boot
                    tree2.root.data["boot"] = 0.0
            
            subtrees2 = []
            for subtree in subtrees:
                subtrees2.extend(splitTree(subtree, stree, gene2species)[1])
            
            # return subtrees
            return True, subtrees2
        
        # tree only needs rerooting
        return True, [tree]
        
    # nothing needs to change
    return False, [tree]
    

for filename in conf["REST"]:
    tree = treelib.readTree(filename)
    split, subtrees = splitTree(tree, stree, gene2species)
    
    if split:
        for i, subtree in enumerate(subtrees):
            subtreename = util.replaceExt(filename, conf["treeext"],
                                          "." + str(i) + conf["subtreeext"])
            subtree.write(subtreename)



    
    
